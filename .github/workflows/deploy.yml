name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - prod

env:
  AZURE_ENV_NAME: ${{ github.event.inputs.environment }}
  DOTNET_VERSION: '8.0.x'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Build and Publish
      run: |
        dotnet publish ./src/WeatherFunction.csproj \
          --configuration Release \
          --output ./publish \
          /p:BUILD_SOURCEVERSION=${{ github.sha }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: function-app-${{ github.sha }}
        path: ./publish

  deploy-infra:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Infrastructure
      uses: azure/arm-deploy@v2
      id: deploy
      with:
        scope: subscription
        region: ${{ secrets.AZURE_LOCATION || 'westus3' }}
        template: ./infra/main.bicep
        parameters: >
          environmentName=${{ env.AZURE_ENV_NAME }}
          location=${{ secrets.AZURE_LOCATION || 'westus3' }}
          gitSha=${{ github.sha }}
        deploymentName: 'deploy-${{ github.sha }}'

    - name: Set outputs
      id: infra
      run: |
        echo "functionAppName=${{ steps.deploy.outputs.AZURE_FUNCTION_APP_NAME }}" >> $GITHUB_OUTPUT
        echo "resourceGroup=${{ steps.deploy.outputs.AZURE_RESOURCE_GROUP }}" >> $GITHUB_OUTPUT

  deploy-app:
    runs-on: ubuntu-latest
    needs: deploy-infra

    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: function-app-${{ github.sha }}
        path: ./publish

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Function App
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ needs.deploy-infra.outputs.functionAppName }}
        package: ./publish
        publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
